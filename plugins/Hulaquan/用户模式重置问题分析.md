# 用户 attention_to_hulaquan 变成 0 的原因分析

## 🔍 调查结论

经过深入检查代码，**没有发现会自动将用户模式重置为 0 的逻辑**。

---

## ✅ 已排除的可能性

### 1. ❌ add_user 不会覆盖现有用户
```python
def add_user(self, user_id):
    if user_id in self.data["users_list"]:
        return  # 如果用户已存在，直接返回，不会覆盖
    # 只有新用户才会初始化为 0
    self.data["users"][user_id] = USER_MODEL()
```

### 2. ❌ update_user_keys 不会重置现有值
```python
def update_user_keys(self, user_id):
    def goto(origin, model):
        for k, v in model.items():
            if k not in origin:
                origin[k] = v  # 只添加缺失的key
            # 不会覆盖已存在的值
```

### 3. ❌ check_friend_status 不会重置
```python
async def check_friend_status(self, bot):
    for user_id in self.users_list():
        if user_id not in friends:
            # 删除不在好友列表的用户
            if r['retcode'] == 1200:
                self.delete_user(user_id)
        else:
            self.add_user(user_id)  # 已存在时不会覆盖
```

### 4. ❌ switch_attention_to_hulaquan 需要显式调用
```python
def switch_attention_to_hulaquan(self, user_id, mode=0, is_group=False):
    # 只有用户发送 /呼啦圈通知 命令时才会调用
    self.data[key][user_id]["attention_to_hulaquan"] = mode
```

---

## ⚠️ 可能的真实原因

### 原因1：数据保存失败（最可能）

**场景：**
1. 用户设置了模式 1/2/3
2. 数据在内存中更新成功
3. 但保存到文件时失败（磁盘满、权限问题、程序崩溃等）
4. 重启后从旧文件加载，用户模式还是 0

**证据：**
- 保存逻辑在 `BaseDataManager.save()` 中
- 如果 `self.updating = True` 时保存会失败
- 如果写入磁盘失败，数据会丢失

**解决方案：**
- 增加保存日志
- 检查备份文件（`.bak`）
- 定期检查数据文件完整性

---

### 原因2：数据文件被覆盖/恢复

**场景：**
1. 用户设置了模式
2. 但某些原因导致数据文件被旧版本覆盖：
   - 从备份恢复
   - Git 操作导致文件回滚
   - 多个进程同时写入

**证据：**
- 数据文件路径：`data/data_manager/UsersManager.json`
- 有备份机制：`UsersManager.json.bak`

**解决方案：**
- 检查 Git 历史
- 确保只有一个 Bot 实例运行
- 启用文件锁机制

---

### 原因3：用户误操作

**场景：**
- 用户自己发送了 `/呼啦圈通知 0`
- 但忘记了

**证据：**
- 这是唯一能改变模式的用户命令

**解决方案：**
- 添加操作日志
- 记录模式变更历史

---

### 原因4：数据文件损坏

**场景：**
1. JSON 文件损坏
2. 加载时抛出 `JSONDecodeError`
3. `self.data = {}` 重置为空字典
4. 所有用户数据丢失

**证据：**
```python
def load(self):
    try:
        self.data = json.load(f)
    except json.JSONDecodeError as e:
        self.data = {}  # ⚠️ 所有数据丢失
        raise
```

**解决方案：**
- 检查日志中是否有 JSONDecodeError
- 使用备份文件恢复
- 增强错误处理，尝试修复损坏的 JSON

---

## 🛠️ 推荐的排查方法

### 1. 添加详细日志

修改 `switch_attention_to_hulaquan` 方法：

```python
def switch_attention_to_hulaquan(self, user_id, mode=0, is_group=False):
    if not isinstance(user_id, str):
        user_id = str(user_id)
    key = "users" if not is_group else "groups"
    
    # 记录旧值
    old_mode = self.data[key].get(user_id, {}).get("attention_to_hulaquan", "N/A")
    
    try:
        self.data[key][user_id]["attention_to_hulaquan"] = mode
    except KeyError:
        if key == "users":
            self.add_user(user_id)
        else:
            self.add_group(user_id)
        self.data[key][user_id]["attention_to_hulaquan"] = mode
    
    # 记录变更
    log.info(f"🔄 [模式变更] {key}={user_id}, {old_mode} -> {mode}")
    return mode
```

### 2. 添加保存成功日志

修改 `save_all` 函数：

```python
async def save_all(on_close=False):
    success = 1
    log.info("💾 [开始保存] 保存所有数据管理器")
    for manager in managers:
        result = await manager.save(on_close)
        success *= int(result['success'])
        if result['success']:
            log.info(f"✅ [保存成功] {manager.__class__.__name__}")
        else:
            log.error(f"❌ [保存失败] {manager.__class__.__name__}, updating={result.get('updating')}")
    return bool(success)
```

### 3. 定期备份数据文件

添加自动备份任务：

```python
async def backup_user_data(self):
    """每天自动备份用户数据"""
    import shutil
    from datetime import datetime
    
    source = "data/data_manager/UsersManager.json"
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    backup = f"data/backups/UsersManager_{timestamp}.json"
    
    os.makedirs("data/backups", exist_ok=True)
    shutil.copy2(source, backup)
    log.info(f"📦 [备份完成] {backup}")
```

### 4. 检查数据完整性

添加验证工具：

```python
def validate_user_data(self):
    """验证用户数据完整性"""
    issues = []
    
    for user_id in self.data.get("users_list", []):
        user = self.data.get("users", {}).get(user_id)
        
        if user is None:
            issues.append(f"用户 {user_id} 在 users_list 中但不在 users 字典中")
            continue
        
        if "attention_to_hulaquan" not in user:
            issues.append(f"用户 {user_id} 缺少 attention_to_hulaquan 字段")
        
        mode = user.get("attention_to_hulaquan")
        if mode not in [0, 1, 2, 3, "0", "1", "2", "3"]:
            issues.append(f"用户 {user_id} 的模式值无效: {mode}")
    
    if issues:
        log.warning(f"⚠️ [数据验证] 发现 {len(issues)} 个问题:\n" + "\n".join(issues))
    else:
        log.info("✅ [数据验证] 用户数据完整")
    
    return issues
```

---

## 📊 立即检查项

### 1. 查看最近的日志
```powershell
Select-String -Path f:\MusicalBot\logs\bot.log -Pattern "模式|attention|switch" | Select-Object -Last 50
```

### 2. 检查数据文件
```powershell
# 查看主文件
Get-Content f:\MusicalBot\data\data_manager\UsersManager.json | ConvertFrom-Json

# 查看备份文件
Get-Content f:\MusicalBot\data\data_manager\UsersManager.json.bak | ConvertFrom-Json
```

### 3. 比较文件差异
```powershell
# 检查主文件和备份是否一致
$main = Get-Content f:\MusicalBot\data\data_manager\UsersManager.json
$backup = Get-Content f:\MusicalBot\data\data_manager\UsersManager.json.bak
Compare-Object $main $backup
```

### 4. 查看文件修改时间
```powershell
Get-ChildItem f:\MusicalBot\data\data_manager\UsersManager.json* | 
    Select-Object Name, LastWriteTime, Length
```

---

## 🎯 最终建议

1. **立即添加日志** - 记录所有模式变更
2. **检查备份文件** - 对比主文件和备份
3. **监控保存过程** - 确认数据正确保存
4. **定期备份** - 避免数据丢失
5. **添加数据验证** - 启动时检查数据完整性

---

## 📝 需要收集的信息

如果问题再次发生，请提供：

1. ✅ 用户 ID 和发生时间
2. ✅ 该时段的日志文件
3. ✅ UsersManager.json 和 .bak 文件
4. ✅ 用户是否记得发送过命令
5. ✅ Bot 是否重启过
6. ✅ 磁盘空间是否充足
