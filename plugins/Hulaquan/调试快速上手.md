# 呼啦圈上新通知调试 - 快速上手指南

## 🎯 你的问题
用户反馈上新不会提示，但目前没有真实的上新数据来测试。

## ✅ 已创建的调试工具

我为你创建了完整的调试工具包，包含：

### 1. 💻 在线调试命令（最简单）
直接在 Bot 中使用，无需改代码：

```
/debug通知 check    # 检查定时任务状态
/debug通知 user     # 查看你的关注设置
/debug通知 mock     # 用模拟数据测试（不需要真实上新）
```

### 2. 📁 新增文件
- `plugins/Hulaquan/debug_announcer.py` - 核心调试库
- `plugins/Hulaquan/DEBUG_GUIDE.md` - 完整调试文档
- `plugins/Hulaquan/README_DEBUG.md` - 工具使用说明
- `plugins/Hulaquan/quick_test.py` - 独立测试脚本

### 3. 🔧 代码改动
在 `main.py` 中新增了管理员命令 `/debug通知`

---

## 🚀 立即开始调试（3步）

### Step 1: 检查任务是否在运行
```
发送：/debug通知 check
```

**应该看到：**
```
⏰ 定时任务状态：
运行状态: ✅ 运行中
检测间隔: 120 秒
```

如果显示"❌ 已停止"，执行：
```
/呼啦圈检测  # 开启任务
```

---

### Step 2: 检查你的设置
```
发送：/debug通知 user
```

**应该看到：**
```
👤 用户 xxxxx 的关注设置：
全局模式: 🆕 只推送上新/补票  ✅
```

**如果显示"❌ 不接受通知"：**
```
/呼啦圈通知 1  # 切换到模式1
```

---

### Step 3: 模拟上新测试
```
发送：/debug通知 mock
```

**这会做什么：**
- 创建 4 张虚假的"上新票"
- 根据你的设置生成通知消息
- **不会真的发送给其他人，只是测试**

**如果能生成消息：**
✅ 说明你的设置正确，消息生成逻辑正常
问题可能在：真实数据没有变动，或数据比对环节

**如果不能生成消息：**
❌ 说明你的设置有问题
回到 Step 2 检查模式

---

## 🔍 诊断结果分析

### 场景A：模拟测试成功生成消息
```
✅ 成功生成 2 组消息
```

**说明：**
- ✅ 定时任务正常
- ✅ 你的设置正常
- ✅ 消息生成逻辑正常
- ❓ 问题在：真实环境没有上新，或数据比对有问题

**下一步：**
1. 等待真实的上新（可能确实没有上新）
2. 或者手动触发刷新查看日志：
   ```
   /refresh  # 管理员命令
   ```
3. 查看日志文件：
   ```powershell
   Get-Content f:\MusicalBot\logs\bot.log -Tail 50
   ```

---

### 场景B：模拟测试没有生成消息
```
⚠️ 没有生成任何消息！
```

**说明：**
你的设置有问题

**检查：**
```
/debug通知 user
```

可能原因：
1. 全局模式为 0（不接受通知）
   - 解决：`/呼啦圈通知 1`

2. 只关注了特定剧目，但测试数据用的是其他剧目
   - 解决：设置全局模式，或用 `/关注学生票` 关注更多剧目

---

### 场景C：任务根本没运行
```
运行状态: ❌ 已停止
```

**解决：**
```
/呼啦圈检测  # 管理员命令，开启任务
```

然后重新执行 Step 1-3

---

## 🎓 理解关注模式

### 模式对照表
| 命令 | 模式 | 接收的通知 |
|------|------|-----------|
| `/呼啦圈通知 0` | ❌ 关闭 | 不接收任何通知 |
| `/呼啦圈通知 1` | 🆕 基础 | 上新、补票 |
| `/呼啦圈通知 2` | 🔄 进阶 | 上新、补票、回流 |
| `/呼啦圈通知 3` | 📊 完整 | 上新、补票、回流、增减票 |

### 推荐设置
- **普通用户**：模式 1 或 2
- **重度用户**：模式 3
- **临时关闭**：模式 0

---

## 📊 实际案例

### 案例1：用户A反馈收不到通知

```
调试步骤：
1. /debug通知 check  → ✅ 任务运行中
2. /debug通知 user   → ❌ 全局模式: 不接受通知
3. /呼啦圈通知 1      → 切换到模式1
4. /debug通知 mock   → ✅ 成功生成消息

结论：问题已解决，是用户设置问题
```

### 案例2：用户B反馈收不到通知

```
调试步骤：
1. /debug通知 check  → ✅ 任务运行中
2. /debug通知 user   → ✅ 全局模式: 只推送上新/补票
3. /debug通知 mock   → ✅ 成功生成消息
4. 查看日志          → 发现：数据比对总是返回空

结论：可能没有真实上新，或数据源有问题
建议：监控一段时间，或减小检测间隔
```

---

## 🛠️ 进阶调试

如果基础调试无法解决问题，使用：

### 查看详细日志
```powershell
# Windows PowerShell
cd f:\MusicalBot

# 查看最新日志
Get-Content logs\bot.log -Tail 100

# 搜索关键词
Select-String -Path logs\bot.log -Pattern "呼啦圈|announcer" | Select-Object -Last 20
```

### 运行独立测试脚本
```powershell
cd plugins\Hulaquan
python quick_test.py
```

### 在代码中使用调试器
```python
from plugins.Hulaquan.debug_announcer import AnnouncerDebugger, run_debug_tests

# 完整测试
await run_debug_tests(plugin_instance)

# 或单独使用
debugger = AnnouncerDebugger(plugin_instance)
debugger.check_task_status()
debugger.print_user_settings("QQ号")
```

---

## ❓ 常见问题

### Q: mock 测试成功，但实际不收到通知？
**A:** 可能真的没有上新，或者：
- 检测间隔太长（用户已通过其他途径知道）
- 数据源问题
- 网络问题

**解决：**
- 手动 `/refresh` 查看是否有变动
- 查看日志确认
- 减小检测间隔

### Q: 定时任务显示运行中，但好像没在工作？
**A:** 添加日志确认：
```powershell
# 查看日志，看是否有定时执行的记录
Select-String -Path f:\MusicalBot\logs\bot.log -Pattern "呼啦圈" | Select-Object -Last 20
```

如果没有任何记录，说明任务可能卡住了，重启 bot。

### Q: 为什么 mock 测试能生成，但实际总是没有变动？
**A:** 这是正常的！呼啦圈可能确实没有上新。

**验证方法：**
- 等待一段时间（几天）
- 或者咨询其他用户是否有上新
- 或者减小检测间隔到 60 秒测试

---

## 📝 调试清单

完成以下检查：

- [ ] 定时任务是否运行中？（`/debug通知 check`）
- [ ] 全局模式是否为 1/2/3？（`/debug通知 user`）
- [ ] 模拟测试能否生成消息？（`/debug通知 mock`）
- [ ] 日志中是否有错误？（查看 `bot.log`）
- [ ] 是否等待了足够长的时间？（可能确实没上新）

---

## 🎉 完成！

现在你可以：

1. ✅ 使用 `/debug通知` 命令随时调试
2. ✅ 用模拟数据测试，**不需要等待真实上新**
3. ✅ 快速定位问题（用户设置 vs 系统问题）
4. ✅ 查看详细的调试文档（`DEBUG_GUIDE.md`）

**建议：**
1. 先让反馈问题的用户执行 `/debug通知` 三步
2. 根据结果判断是设置问题还是系统问题
3. 大多数情况是用户模式设置为 0 或没开启

祝调试顺利！ 🚀
